name: multi-party-approval
version: "1.0.0"
description: "Canonical pattern for multi-party approval workflows requiring consensus"
tags:
  - approval
  - multi-party
  - workflow
  - authorization
  - consensus
author: "Digital Asset"
created_at: "2024-01-15T10:00:00Z"
updated_at: "2024-01-15T10:00:00Z"

pattern_type: approval_workflow
daml_template: |
  template MultiPartyApproval
    with
      asset: Asset
      approvers: [Party]
      requiredApprovals: Int
      approvals: [Party]
    where
      signatory approvers
      observer asset.owner
      
      choice Approve : ContractId MultiPartyApproval
        controller approver: Party
        do
          assert approver `elem` approvers
          assert approver `notElem` approvals
          create this with approvals = approvals `union` [approver]
      
      choice Execute : ContractId Asset
        controller asset.owner
        do
          assert length approvals >= requiredApprovals
          asset

authorization_requirements:
  - id: REQ-AUTH-001
    rule: "All approvers must be signatories"
    satisfied: true
    explanation: "approvers list defines signatories, ensuring all parties with approval authority are signatories"
  - id: REQ-AUTH-002
    rule: "Only approvers can approve"
    satisfied: true
    explanation: "Approve choice controller must be in approvers list"
  - id: REQ-AUTH-003
    rule: "Execution requires sufficient approvals"
    satisfied: true
    explanation: "Execute choice checks that requiredApprovals threshold is met"

when_to_use:
  - "Multi-signature wallets requiring multiple approvals"
  - "Corporate governance decisions with board approval"
  - "Asset transfers requiring multiple party consent"
  - "Compliance workflows with approval gates"

when_not_to_use:
  - "Simple bilateral agreements"
  - "Time-sensitive operations requiring immediate execution"
  - "Scenarios where single-party authority is sufficient"

security_considerations:
  - "Ensure approvers list is properly validated and immutable"
  - "Consider adding timeout mechanisms for approval deadlines"
  - "Validate that requiredApprovals is reasonable (not 0 or > number of approvers)"
  - "Implement proper audit logging for approval actions"

test_cases:
  - description: "Valid approval workflow"
    passes: true
    code: "alice and bob approve asset transfer, charlie executes"
  - description: "Insufficient approvals"
    passes: false
    expected_error: "Insufficient approvals"
    code: "only alice approves, charlie attempts execution"
  - description: "Unauthorized approval attempt"
    passes: false
    expected_error: "Not authorized"
    code: "dave attempts to approve without being in approvers list"
